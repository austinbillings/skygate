"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,s=Array(e.length);r<e.length;r++)s[r]=e[r];return s}return Array.from(e)}var express=require("express"),zaq=require("zaq"),lex=require("./app/lex.js"),users=require("./config/users.json"),skygate=require("./app/skygate.js")({users:users,cookieName:"_SkyGateAuthToken"}),app=express(),port=1919,live=__dirname+"/demo";app.use("/session",skygate.mount()),app.use("/",express.static(live)),app.listen(port),zaq.win(lex.ServerOk),zaq.info("Running on "+port),module.exports={ServerOk:"SkyGate Server Initialized",ServerFail:"SkyGate Server Failed to Start",GenericError:"An unknown error occurred.",Unauthorized:"You need to be logged in to do that.",AlreadyLoggedIn:"You are already logged in.",MaxAttemptsReached:"Too many invalid login attempts.",NoInput:"No input provided.",NoUserId:"No user ID provided.",NoName:"No name provided.",NoPass:"No password provided.",BadUserOrPass:"Incorrect username or password given."};var zaq=require("zaq"),chalk=require("chalk"),_=require("underscore"),uid=require("node-uuid"),moment=require("moment"),crypto=require("crypto"),jawn=require("node-jawn"),express=require("express"),bodyParser=require("body-parser"),cookieParser=require("cookie-parser"),Lex=require("./lex.js"),skygate=function(e){e=_.defaults(e,{users:null,mode:"id",algo:"sha256",cookieName:"_AuthToken",maxAttempts:10,maxAge:108e5,exposableUserKeys:["id","email"],tests:{id:/^[a-zA-Z0-9_-]{3,40}$/,name:/^[a-zA-Z ]{1,40}$/,email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,pass:/^[a-zA-Z0-9!@#`~%^&?_-]{10,36}$/}});var r={users:e.users,live:{sessions:[],attempts:{}}};return r.fail=function(e,s,t){for(var n=arguments.length,o=Array(n>3?n-3:0),i=3;i<n;i++)o[i-3]=arguments[i];var a=r.getIpAddress(e);t=_.defaults(t,{message:Lex.GenericError,success:!1,warnings:e.warnings&&e.warnings.length?e.warnings:[],code:400}),r.updateToken(),s.status(t.code).send(t),zaq.err(t.message,"IP: "+a),o&&_.each(o,zaq.obj)},r.warn=function(e,r){e.warnings&&e.warnings.length||(e.warnings=[]),e.warnings.push(r)},r.getIpAddress=function(e){return e?e.headers["x-forwarded-for"]||e.connection.remoteAddress:null},r.getToken=function(r){return!!(r&&r.cookies&&r.cookies[e.cookieName])&&r.cookies[e.cookieName]},r.getSession=function(e){return _.findWhere(r.live.sessions,{token:e})},r.getUserById=function(e){return _.findWhere(r.users,{id:e})},r.getUserByToken=function(e){var s=r.getSession(e);return s&&s.user&&s.user.id?r.getUserById(s.user.id):null},r.getUser=function(e){return r.isLoggedIn(e)?r.getUserByToken(r.getToken(e)):null},r.vetUser=function(r){return _.pick.apply(_,[r].concat(_toConsumableArray(e.exposableUserKeys)))},r.isLoggedIn=function(e){var s=r.getToken(e),t=r.getSession(s);return!(!s||!t)},r.echoStatus=function(e,s){s.send({loggedIn:r.isLoggedIn(e),user:r.vetUser(r.getUser(e))})},r.requireLoggedIn=function(e,s,t){var n=r.getToken(e),o=Lex.Unauthorized;return r.isLoggedIn(e)?t():r.fail(e,s,{code:401,token:n,message:o})},r.registerAuthAttempt=function(e,s,t){var n=r.getIpAddress(e),o=_.has(r.live.attempts,n)?r.live.attempts[n]:r.isLoggedIn(e)?-1:0;e.authAttempts=r.live.attempts[n]=o+1,t()},r.updateToken=function(s,t,n){var o=e.maxAge,i=r.getToken(s);if(i){r.getSession(i)||(o=1),t.cookie(e.cookieName,i,{maxAge:o}),n&&n()}},r.logSessionList=function(){var e=r.live.sessions,s=chalk.dim.blue(" â†’ :::::  "),t=_.map(e,function(e){var r=e.token.substr(0,8)+"...",t=moment(e.start).format("h:mm:ss");return""+s+chalk.dim.cyan(t)+" "+chalk.blue.bold(e.user.id)+" "+chalk.dim("from")+" "+chalk.yellow(e.ip)+" "+chalk.dim("with")+" "+chalk.dim.green.bold(r)});zaq.info("Current Sessions ("+r.live.sessions.length+")"),zaq.log(t.join("\n"))},r.newSession=function(s,t,n){var o=uid.v4(),i=e.maxAge,a=r.getIpAddress(s),u=r.vetUser(n),d=(new Date).getTime(),c={user:u,ip:a,start:d,success:!0},l={user:u,ip:a,start:d,token:o};r.live.sessions.push(l),zaq.win("Session started: "+chalk.dim(o)),r.logSessionList(),t.cookie(e.cookieName,o,{maxAge:i}),t.send(c)},r.killSession=function(e){zaq.win("Session killed: "+chalk.dim(e)),r.logSessionList(),r.live.sessions=_.reject(r.live.sessions,{token:e})},r.attemptAuthentication=function(s){return new Promise(function(t,n){var o=s.id,i=s.pass,a=s.email;_.isObject(s)||n(Lex.NoInput);var u;switch(e.mode){case"id":_.isString(o)||n(Lex.NoUserId),o=o.toLowerCase(),u={id:o};break;case"email":_.isString(a)||n(Lex.NoEmail),a=a.toLowerCase(),u={email:a}}_.isString(i)||n(Lex.NoPass);var d=_.findWhere(r.users,u);_.isObject(d)||n(Lex.BadUserOrPass),r.checkUserPassword(i,d)||n(Lex.BadUserOrPass),t(d)})},r.checkUserPassword=function(r,s){var t=s.salt,n=s.pass;return crypto.createHash(e.algo).update(r).update(t).digest("hex")===n},r.generateSalt=function(){return crypto.randomBytes(16).toString("hex")},r.login=function(s,t){if(r.isLoggedIn(s)){var n=Lex.AlreadyLoggedIn;return r.fail(s,t,{message:n,code:409})}if(s.authAttempts>=e.maxAttempts){var o=Lex.MaxAttemptsReached;return r.fail(s,t,{message:o,code:429})}return r.attemptAuthentication(s.body).then(function(e){return r.newSession(s,t,e)},function(e){return r.fail(s,t,{message:e})})},r.logout=function(e,s){r.killSession(r.getToken(e)),r.updateToken(),r.echoStatus(e,s)},r.mount=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",s=new express.Router;return s.use(cookieParser()),s.use(bodyParser.urlencoded({extended:!0,limit:"50mb"})),s.use(bodyParser.json({limit:"50mb"})),s.get(e,function(e,s){return r.echoStatus(e,s)}),s.post(e,function(e,s){return r.login(e,s)}),s.delete(e,function(e,s){return r.logout(e,s)}),s},r};module.exports=skygate;