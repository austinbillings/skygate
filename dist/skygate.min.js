"use strict";var express=require("express"),zaq=require("zaq"),lex=require("./app/lex.js"),cookieParser=require("cookie-parser"),skygate=require("./app/skygate.js")({users:require("./config/users.json"),cookieName:"_SkyGateAuthToken"}),app=express(),port=1919,live=__dirname+"/demo";app.use(cookieParser()),app.use("/session",skygate.toEndpoint()),app.use("/",express.static(live)),app.listen(port),zaq.win(lex.ServerOk),zaq.info("Running on "+port),module.exports={ServerOk:"SkyGate Server Initialized",ServerFail:"SkyGate Server Failed to Start",GenericError:"An unknown error occurred.",Unauthorized:"You need to be logged in to do that.",MaxAttemptsReached:"Too many invalid login attempts.",NoInput:"No input provided.",NoName:"No name provided.",NoPass:"No password provided."};var zaq=require("zaq"),_=require("underscore"),uid=require("node-uuid"),jawn=require("node-jawn"),express=require("express"),bodyParser=require("body-parser"),cookieParser=require("cookie-parser"),Lex=require("./lex.js"),skygate=function(e){e=_.defaults(e,{users:null,cookieName:"_AuthToken",maxAttempts:10,maxAge:108e5});var s={users:e.users,live:{sessions:[],attempts:{}}};return s.fail=function(e,s,r){for(var n=arguments.length,t=Array(n>3?n-3:0),o=3;o<n;o++)t[o-3]=arguments[o];r=_.defaults(r,{message:Lex.GenericError,success:!1,warnings:e.warnings&&e.warnings.length?e.warnings:[],code:400}),s.status(r.code).send(r),zaq.err(r.message,r),t&&_.each(t,zaq.obj)},s.warn=function(e,s){e.warnings&&e.warnings.length||(e.warnings=[]),e.warnings.push(s)},s.getIpAddress=function(e){return e.headers["x-forwarded-for"]||e.connection.remoteAddress},s.getToken=function(s){return s&&s.cookies&&s.cookies[e.cookieName]},s.isLoggedIn=function(e){var r=s.getToken(e);return r&&_.contains(s.sessions,r)},s.requireLoggedIn=function(e,r,n){var t={code:401,token:s.getToken(e),message:Lex.Unauthorized};return s.isLoggedIn(e)?n():s.fail(e,r,t)},s.registerAuthAttempt=function(e,r,n){var t=s.getIpAddress(e),o=_.has(s.live.attempts,t)?s.live.attempts[t]:s.isLoggedIn(e)?-1:0;e.authAttempts=s.live.attempts[t]=o+1,n()},s.validateToken=function(r,n,t){var o=s.getToken(r);o&&(_.contains(s.live.sessions,o)||n.cookie(e.cookieName,o,{maxAge:1}),t&&t())},s.newSession=function(r,n,t){var o=uid.v4(),i={maxAge:e.maxAge},a={token:o,success:!0},u={token:o,uid:t.id};s.live.sessions.push(u),zaq.win("Session started",o),zaq.info("Current sessions",s.live.sessions),n.cookie(e.cookieName,o,i),n.send(a)},s.getStatus=function(e,r){var n;return n=s.isLoggedIn(e)?{success:!0,loggedIn:!0}:{success:!0,loggedIn:!1},r.send(n)},s.check=function(e){return new Promise(function(s,r){_.keys(e).length||r(Lex.NoInput),_.isString(e.name)||r(Lex.NoName),_.isString(e.pass)||r(Lex.NoPass),s({name:"steve brewer",id:"poop"})})},s.login=function(r,n){if(s.isLoggedIn(r))return s.getStatus(r,n);if(r.authAttempts>=e.maxAttempts){var t=Lex.MaxAttemptsReached;return s.fail(r,n,{message:t})}return s.check(r.body).then(function(e){return s.newSession(r,n,e)},function(e){return s.fail(r,n,{message:e})})},s.logout=function(e,r){return s.isLoggedIn(e)&&(s.live.sessions=_.without(s.live.sessions,s.getToken(e))),s.validateToken(),s.getStatus(e,r)},s.toEndpoint=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",r=new express.Router;return r.use(cookieParser()),r.use(bodyParser.urlencoded({extended:!0,limit:"50mb"})),r.use(bodyParser.json({limit:"50mb"})),r.get(e,function(e,r){return s.getStatus(e,r)}),r.post(e,function(e,r){return s.login(e,r)}),r.delete(e,function(e,r){return s.logout(e,r)}),r},s};module.exports=skygate;